name: Daily Commit Summary & Telegram Notification

on:
  schedule:
    # æ¯å¤©æ™šä¸Š 23:00 (UTC+8 15:00) è¿è¡Œ
    - cron: '0 15 * * *'
  workflow_dispatch:
    inputs:
      date:
        description: 'æŒ‡å®šæ—¥æœŸ (YYYY-MM-DDï¼Œé»˜è®¤ä¸ºä»Šå¤©)'
        required: false
        type: string

jobs:
  daily-summary:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    
    steps:
    - name: Checkout TeleBox_Plugins repository
      uses: actions/checkout@v4
      with:
        path: TeleBox_Plugins
        fetch-depth: 0
        
    - name: Checkout TeleBox repository
      id: checkout-telebox
      uses: actions/checkout@v4
      with:
        repository: TeleBoxOrg/TeleBox
        path: TeleBox
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}
      continue-on-error: true
        
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: Generate commit summary and send to Telegram
      env:
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        TARGET_DATE: ${{ github.event.inputs.date }}
        CHECKOUT_SUCCESS: ${{ steps.checkout-telebox.outcome == 'success' }}
      run: |
        cat > commit-summary.js << 'EOF'
        const { execSync } = require('child_process');
        const https = require('https');
        const querystring = require('querystring');
        
        // é…ç½®
        const BOT_TOKEN = process.env.TELEGRAM_BOT_TOKEN;
        const CHAT_ID = process.env.TELEGRAM_CHAT_ID;
        const TARGET_DATE = process.env.TARGET_DATE || new Date().toISOString().split('T')[0];
        const CHECKOUT_SUCCESS = process.env.CHECKOUT_SUCCESS === 'true';
        
        // éªŒè¯ç¯å¢ƒå˜é‡
        if (!BOT_TOKEN || !CHAT_ID) {
          console.error('âŒ ç¼ºå°‘å¿…è¦çš„ç¯å¢ƒå˜é‡: TELEGRAM_BOT_TOKEN æˆ– TELEGRAM_CHAT_ID');
          process.exit(1);
        }
        
        console.log(`ğŸ“… ç”Ÿæˆ ${TARGET_DATE} çš„æäº¤æ‘˜è¦`);
        
        // è·å–æŒ‡å®šæ—¥æœŸçš„æäº¤
        function getCommitsForDate(repoPath, repoName, date) {
          try {
            const since = `${date} 00:00:00`;
            const until = `${date} 23:59:59`;
            
            const gitLog = execSync(
              `cd ${repoPath} && git log --since="${since}" --until="${until}" --pretty=format:"%h|%s|%an|%ad" --date=format:"%H:%M"`,
              { encoding: 'utf8' }
            ).trim();
            
            if (!gitLog) {
              return [];
            }
            
            return gitLog.split('\n').map(line => {
              const [hash, message, author, time] = line.split('|');
              return {
                hash: hash.trim(),
                message: message.trim(),
                author: author.trim(),
                time: time.trim(),
                repo: repoName
              };
            });
          } catch (error) {
            console.warn(`âš ï¸ è·å– ${repoName} æäº¤è®°å½•å¤±è´¥:`, error.message);
            return [];
          }
        }
        
        // è·å–ä¸¤ä¸ªä»“åº“çš„æäº¤
        const teleboxCommits = CHECKOUT_SUCCESS ? getCommitsForDate('TeleBox', 'TeleBox', TARGET_DATE) : [];
        const pluginsCommits = getCommitsForDate('TeleBox_Plugins', 'TeleBox_Plugins', TARGET_DATE);
        
        if (!CHECKOUT_SUCCESS) {
          console.warn('âš ï¸ TeleBox ä»“åº“è®¿é—®å¤±è´¥ï¼Œä»…ç»Ÿè®¡ TeleBox_Plugins æäº¤');
        }
        
        // å»é‡å’Œè¿‡æ»¤æäº¤ä¿¡æ¯
        function deduplicateCommits(commits) {
          const seen = new Set();
          const filtered = [];
          
          for (const commit of commits) {
            // è·³è¿‡è‡ªåŠ¨åŒ–æäº¤
            if (commit.message.includes('ğŸ¤– è‡ªåŠ¨æ›´æ–°æ’ä»¶åˆ—è¡¨') || 
                commit.message.includes('Merge pull request') ||
                commit.message.match(/^Update \w+\.(json|yml|md)$/)) {
              continue;
            }
            
            // åŸºäºæ¶ˆæ¯å†…å®¹å»é‡
            const key = commit.message.toLowerCase().trim();
            if (!seen.has(key)) {
              seen.add(key);
              filtered.push(commit);
            }
          }
          
          return filtered;
        }
        
        const dedupedTeleboxCommits = deduplicateCommits(teleboxCommits);
        const dedupedPluginsCommits = deduplicateCommits(pluginsCommits);
        const allCommits = [...dedupedTeleboxCommits, ...dedupedPluginsCommits];
        
        if (allCommits.length === 0) {
          console.log('ğŸ“­ ä»Šæ—¥æ— æäº¤è®°å½•');
          
          // å‘é€æ— æäº¤çš„é€šçŸ¥
          const noCommitsMessage = `ğŸ“… TeleBox æ—¥æŠ¥ - ${TARGET_DATE}\n\nğŸŒ™ ä»Šæ—¥æ— ä»£ç æäº¤\n\nä¿æŒä»£ç æ•´æ´ï¼Œæ˜æ—¥å†æˆ˜ï¼`;
          
          sendToTelegram(noCommitsMessage);
          return;
        }
        
        // æŒ‰ä»“åº“åˆ†ç»„æäº¤
        const commitsByRepo = {
          'TeleBox': dedupedTeleboxCommits,
          'TeleBox_Plugins': dedupedPluginsCommits
        };
        
        // ç”Ÿæˆæ‘˜è¦æ¶ˆæ¯
        let message = `ğŸ“… TeleBox æ—¥æŠ¥ - ${TARGET_DATE}\n\n`;
        message += `ğŸ“Š ä»Šæ—¥æäº¤ç»Ÿè®¡\n`;
        message += `â€¢ æ€»æäº¤æ•°: ${allCommits.length}\n`;
        message += `â€¢ TeleBox: ${dedupedTeleboxCommits.length} æ¬¡æäº¤\n`;
        message += `â€¢ TeleBox_Plugins: ${dedupedPluginsCommits.length} æ¬¡æäº¤\n\n`;
        
        // æ·»åŠ è¯¦ç»†æäº¤ä¿¡æ¯ (é™åˆ¶æ˜¾ç¤ºæ•°é‡é¿å…æ¶ˆæ¯è¿‡é•¿)
        for (const [repoName, commits] of Object.entries(commitsByRepo)) {
          if (commits.length === 0) continue;
          
          message += `ğŸ”§ ${repoName}\n`;
          
          // é™åˆ¶æ¯ä¸ªä»“åº“æœ€å¤šæ˜¾ç¤º10æ¡æäº¤
          const displayCommits = commits.slice(0, 10);
          
          displayCommits.forEach(commit => {
            // ç®€åŒ–æäº¤ä¿¡æ¯ï¼Œç§»é™¤å¸¸è§å‰ç¼€
            let cleanMessage = commit.message
              .replace(/^(feat|fix|docs|style|refactor|test|chore|perf)(\(.+\))?: /, '')
              .replace(/^(ğŸ‰|ğŸ›|ğŸ“|ğŸ’„|â™»ï¸|âœ…|ğŸ”§|âš¡|ğŸš€|ğŸ“¦|ğŸ”€|âª|ğŸ”–|ğŸ’š|ğŸ‘·|ğŸ“ˆ|â™¿|ğŸ±|ğŸš¨|ğŸ”‡|ğŸ‘¥|ğŸšš|ğŸ“„|âš—ï¸|ğŸ·ï¸|ğŸŒ|ğŸ’«|ğŸ—‘ï¸|ğŸ”Š|ğŸ”‡|ğŸ›|ğŸ’©|âª|ğŸ”€|ğŸ“¦|ğŸ‘½|ğŸšš|ğŸ“±|ğŸ¤¡|ğŸ¥š|ğŸ™ˆ|ğŸ“¸|âš—ï¸|ğŸ”|ğŸ·ï¸|ğŸŒ±|ğŸš©|ğŸ’¥|ğŸ±|â™¿|ğŸ’¬|ğŸ—ƒï¸|ğŸ”Š|ğŸ“ˆ|âš—ï¸|ğŸ”|ğŸ·ï¸)\s*/, '')
              .substring(0, 50);
            
            if (commit.message.length > 50) {
              cleanMessage += '...';
            }
            
            message += `â€¢ \`${commit.hash}\` ${cleanMessage} _${commit.time}_\n`;
          });
          
          // å¦‚æœæœ‰æ›´å¤šæäº¤ï¼Œæ˜¾ç¤ºçœç•¥ä¿¡æ¯
          if (commits.length > 10) {
            message += `â€¢ _... è¿˜æœ‰ ${commits.length - 10} æ¡æäº¤_\n`;
          }
          
          message += '\n';
        }
        
        // æ·»åŠ è´¡çŒ®è€…ç»Ÿè®¡
        const contributors = [...new Set(allCommits.map(c => c.author))];
        if (contributors.length > 0) {
          message += `ğŸ‘¥ ä»Šæ—¥è´¡çŒ®è€…\n`;
          contributors.forEach(author => {
            const authorCommits = allCommits.filter(c => c.author === author).length;
            message += `â€¢ ${author}: ${authorCommits} æ¬¡æäº¤\n`;
          });
          message += '\n';
        }
        
        // æ·»åŠ æ—¶é—´æˆ³
        message += `â° æŠ¥å‘Šç”Ÿæˆæ—¶é—´: ${new Date().toLocaleString('zh-CN', { timeZone: 'Asia/Shanghai' })}`;
        
        // æ£€æŸ¥æ¶ˆæ¯é•¿åº¦ï¼ŒTelegram é™åˆ¶ä¸º 4096 å­—ç¬¦
        if (message.length > 4000) {
          console.warn('âš ï¸ æ¶ˆæ¯è¿‡é•¿ï¼Œè¿›è¡Œæˆªæ–­å¤„ç†');
          message = message.substring(0, 3900) + '\n\n_... æ¶ˆæ¯è¿‡é•¿å·²æˆªæ–­_';
        }
        
        console.log('ğŸ“ ç”Ÿæˆçš„æ¶ˆæ¯:');
        console.log(message);
        
        // å‘é€åˆ° Telegram
        sendToTelegram(message);
        
        function sendToTelegram(text) {
          const data = querystring.stringify({
            chat_id: CHAT_ID,
            text: text,
            disable_web_page_preview: true
          });
          
          const options = {
            hostname: 'api.telegram.org',
            port: 443,
            path: `/bot${BOT_TOKEN}/sendMessage`,
            method: 'POST',
            headers: {
              'Content-Type': 'application/x-www-form-urlencoded',
              'Content-Length': Buffer.byteLength(data)
            }
          };
          
          const req = https.request(options, (res) => {
            let responseData = '';
            
            res.on('data', (chunk) => {
              responseData += chunk;
            });
            
            res.on('end', () => {
              try {
                const response = JSON.parse(responseData);
                if (response.ok) {
                  console.log('âœ… æ¶ˆæ¯å·²æˆåŠŸå‘é€åˆ° Telegram');
                } else {
                  console.error('âŒ Telegram API é”™è¯¯:', response.description);
                  process.exit(1);
                }
              } catch (error) {
                console.error('âŒ è§£æå“åº”å¤±è´¥:', error.message);
                console.error('å“åº”å†…å®¹:', responseData);
                process.exit(1);
              }
            });
          });
          
          req.on('error', (error) => {
            console.error('âŒ å‘é€è¯·æ±‚å¤±è´¥:', error.message);
            process.exit(1);
          });
          
          req.write(data);
          req.end();
        }
        EOF
        
        node commit-summary.js
