name: Update README Plugin List

on:
  push:
    branches: [ main ]
    paths: [ 'plugins.json' ]
  pull_request:
    branches: [ main ]
    paths: [ 'plugins.json' ]
  workflow_dispatch:

jobs:
  update-readme:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: Update README plugin list
      run: |
        cat > update-readme.js << 'EOF'
        const fs = require('fs');
        const path = require('path');
        
        try {
          // è¯»å– plugins.json
          const pluginsData = JSON.parse(fs.readFileSync('plugins.json', 'utf8'));
          
          // è¯»å– README.md
          let readmeContent = fs.readFileSync('README.md', 'utf8');
          
          // æå–æ’ä»¶ä¿¡æ¯å¹¶æ’åºå»é‡
          const plugins = Object.keys(pluginsData)
            .map(name => ({
              name: name.trim(),
              desc: pluginsData[name].desc.trim()
            }))
            .filter((plugin, index, self) => 
              index === self.findIndex(p => p.name === plugin.name)
            )
            .sort((a, b) => a.name.localeCompare(b.name, 'zh-CN'));
          
          // ç”Ÿæˆæ’ä»¶åˆ—è¡¨ markdown (ä¿æŒåŸæ ¼å¼ï¼Œæ¯è¡Œæœ«å°¾æ·»åŠ ä¸¤ä¸ªç©ºæ ¼)
          const pluginListMd = plugins
            .map(plugin => `- \`${plugin.name}\` - ${plugin.desc}  `)
            .join('\n');
          
          // å®šä¹‰æ›¿æ¢çš„å¼€å§‹å’Œç»“æŸæ ‡è®°
          const startMarker = '## å¯ç”¨æ’ä»¶åˆ—è¡¨';
          const endMarker = '## æŠ€æœ¯æ ˆ';
          
          // æŸ¥æ‰¾æ ‡è®°ä½ç½®
          const startIndex = readmeContent.indexOf(startMarker);
          const endIndex = readmeContent.indexOf(endMarker);
          
          if (startIndex === -1 || endIndex === -1) {
            console.error('æœªæ‰¾åˆ°æ’ä»¶åˆ—è¡¨æ ‡è®°');
            process.exit(1);
          }
          
          // æ„å»ºæ–°çš„ README å†…å®¹
          const beforeSection = readmeContent.substring(0, startIndex + startMarker.length);
          const afterSection = readmeContent.substring(endIndex);
          
          const newReadmeContent = `${beforeSection}\n${pluginListMd}\n\n${afterSection}`;
          
          // æ£€æŸ¥å†…å®¹æ˜¯å¦æœ‰å˜åŒ–
          if (readmeContent === newReadmeContent) {
            console.log('âœ… README.md å·²æ˜¯æœ€æ–°çŠ¶æ€ï¼Œæ— éœ€æ›´æ–°');
            process.exit(0);
          }
          
          // å†™å…¥æ›´æ–°åçš„ README.md
          fs.writeFileSync('README.md', newReadmeContent, 'utf8');
          
          console.log(`âœ… å·²æ›´æ–° README.mdï¼Œå…± ${plugins.length} ä¸ªæ’ä»¶`);
          console.log('æ’ä»¶åˆ—è¡¨:', plugins.map(p => p.name).join(', '));
          
        } catch (error) {
          console.error('âŒ æ›´æ–°å¤±è´¥:', error.message);
          process.exit(1);
        }
        EOF
        
        node update-readme.js
        
    - name: Check for changes
      id: verify-changed-files
      run: |
        if [ -n "$(git status --porcelain)" ]; then
          echo "changed=true" >> $GITHUB_OUTPUT
        else
          echo "changed=false" >> $GITHUB_OUTPUT
        fi
        
    - name: Commit and push changes
      if: steps.verify-changed-files.outputs.changed == 'true'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add README.md
        git commit -m "ğŸ¤– è‡ªåŠ¨æ›´æ–°æ’ä»¶åˆ—è¡¨
        
        - ä» plugins.json åŒæ­¥æ’ä»¶ä¿¡æ¯
        - æŒ‰å­—æ¯é¡ºåºæ’åº
        - è‡ªåŠ¨å»é‡å¤„ç†
        
        æ’ä»¶æ•°é‡: $(node -e "console.log(Object.keys(JSON.parse(require('fs').readFileSync('plugins.json', 'utf8'))).length)")"
        git push
